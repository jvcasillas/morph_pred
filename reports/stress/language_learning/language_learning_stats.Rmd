---
author: 
  - name          : "Nuria Sagarra"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "Postal address"
    email         : "my@email.com"
  - name          : "Cristina Lozano-Argüelles"
    affiliation   : "1"
  - name          : "Joseph V. Casillas"
    affilitation  : "1"

affiliation:
  - id            : "1"
    institution   : "Rutgers University"



keywords          : ""
wordcount         : ""

bibliography      : ["r-references.bib"]

floatsintext      : yes
figurelist        : yes
tablelist         : yes
footnotelist      : yes
linenumbers       : yes
mask              : yes
draft             : yes

documentclass     : "apa6"
classoption       : "man"
output            : papaja::apa6_word
---

```{r setup, include = FALSE}
library("papaja")
library("officer")
library("flextable")
```

```{r analysis-preferences}
# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
```

```{r, 'source-scripts-models'}
source(here::here("scripts", "02_load_data.R"))

# Get path to saved models
gca_mods_path  <- here("models", "stress", "s3_adv_int_nat", 
                       "eye_track", "gca")

# Load models as list and store full mod to global env
load(paste0(gca_mods_path, "/full_mods_lang_learn.Rdata"))
load(paste0(gca_mods_path, "/ind_mods_wm.Rdata"))
load(paste0(gca_mods_path, "/nested_model_comparisons_wm.Rdata"))
load(paste0(gca_mods_path, "/model_preds_wm.Rdata"))

gca_wm_coda_mod_int_3 <- full_mods_lang_learn$gca_wm_coda_mod_int_3

```






# Language learning article (stress and working memory with natives, late advanced learners and interpreters)












# Plots

```{r, 'plot-ind-preds', echo=FALSE, fig.cap="Growth curve estimates of target fixations as a function of lexical stress and syllable structure and working memory for each group during the analysis window. Lines represent model estimates at -1, 0, and 1 standard deviations of working memory. The transparent ribbons represents ±SE. Empirical logit values on the y-axis correspond to proportions of 0.12, 0.50, 0.88, and 0.98. The thick horizontal white line represents the 50% probability of fixating on the target. The thick vertical white line indicates 200 ms after the offset of the target syllable."}
knitr::include_graphics(
  here("figs", "stress", "s3_adv_int_nat", "eye_track", "lang_learn", 
  "stress_p1.png")
)
```

```{r, 'plot-group-preds', echo=FALSE, fig.cap="Growth curve estimates of target fixations as a function of lexical stress and syllable structure for each group during the analysis window. Symbols and lines represent model estimates at mean working memory, and the transparent ribbons represents ±SE. Empirical logit values on the y-axis correspond to proportions of 0.12, 0.50, 0.88, and 0.98. The thick horizontal white line represents the 50% probability of fixating on the target. The thick vertical white line indicates 200 ms after the offset of the target syllable."}
knitr::include_graphics(
  here("figs", "stress", "s3_adv_int_nat", "eye_track", "lang_learn", 
  "stress_p2.png")
)
```













# Tables 

## Model estimates at target syllable offset  


```{r, table-target-offset-props, eval=T, echo=F}

border_1 <- fp_border(width = 1.5)
border_2 <- fp_border(width = 0.75)

model_preds_wm$target_offset_wm_preds %>% 
  mutate(coda = if_else(coda == 1, "CV", "CVC"), 
         cond = if_else(cond == 1, "Paroxytone", "Oxytone")) %>% 
  filter(wm == 0) %>% 
  group_by(group, coda, cond) %>% 
  summarize(prob = mean(prob), prob_lb = mean(prob_lb), prob_ub = mean(prob_ub)) %>% 
  ungroup() %>% 
  arrange(group, coda, desc(cond)) %>% 
  mutate(group = blank_same_as_last(as.character(group)), 
         coda =  blank_same_as_last(coda)) %>% 
  select(Group = group, `Lexical stress` = cond, 
         `Syllable structure` = coda, Probability = prob, LB = prob_lb, 
         UB = prob_ub) %>% 
  flextable() %>% 
  width(., j = c(2, 3, 4), width = c(1.1, 1.3, 1.1)) %>% 
  font(., fontname = "Times", part = "all") %>%
  fontsize(., size = 11) %>% 
  border_remove(.) %>%  
  border(., part = "header", 
            border.top = border_1,
            border.bottom = border_2) %>% 
  hline_bottom(., part = "body", border = border_1)
```

*Table 1*: Model estimates at mean working memory for probability of target fixations ±SE at 200 ms after the target syllable offset.




## Fixed effects

```{r, warning=F, eval=T}
fixef_order <- c(1, 2, 3, 4, 5, 9, 13, 17, 6, 7, 8, 10, 11, 12, 21, 14, 18, 
                 15, 19, 16, 20, 25, 29, 22, 23, 24, 33, 37, 26, 27, 28, 30, 
                 31, 32, 34, 38, 35, 39, 36, 40)

pretty_fixed_effects <- gca_wm_coda_mod_int_3 %>% 
  tidy_lme4 %>% 
  mutate(index = fixef_order) %>% 
  arrange(index) %>% 
  select(-index) %>% 
  mutate(p = format_pval(p), 
         Parameter = fix_param_names(Parameter)) %>% 
  mutate_each(funs(format_fixef_num), Estimate:t) %>% 
  rename(`_t_` = t, `_p_` = p) 

# Include gammas (Gij) after each parameter name
subs <- c(paste0(0:3, 0), paste0(0:3, 1), 
          paste0(0:3, 2), paste0(0:3, 3), 
          paste0(0:3, 4), paste0(0:3, 5), 
          paste0(0:3, 6), paste0(0:3, 7), 
          paste0(0:3, 8), paste0(0:3, 9))
var_labels <- parenthesize(paste0(emphasize("&gamma;"), "~", subs, "~"))
pretty_fixed_effects$Parameter %<>% paste(., var_labels)
pretty_fixed_effects$Parameter %<>% str_replace("wm_std", "Working memory")

pretty_fixed_effects %>% 
  select(-effect) %>% 
  knitr::kable(format = "pandoc", align = str_tokenize("lrrrr")) 

```

Appendix 1: Growth curve model fixed effects






## Random effects

```{r, 'ranef-table', results = "asis", eval=T}
ranef_table <- gca_wm_coda_mod_int_3 %>% 
  tidy_ranef_summary %>% 
  # Format the numbers
  mutate_each(funs(format_fixef_num), vcov, sdcor) %>%
  mutate_each(funs(format_cor), -var1, -grp, -vcov, -sdcor) %>%
  sort_ranef_grps %>%
  # Format variable names and group names
  mutate(var1 = fix_param_names(var1) %>% blank_nas,
         grp =  blank_same_as_last(grp) %>% fix_param_names) %>% 
  rename(Group = grp, Parameter = var1, Variance = vcov, SD = sdcor)

# Correlation columns need names with characters so that pandoc can align them
names(ranef_table)[5:10] <- 
  c("Correlations", "&nbsp;", " &nbsp;", "  &nbsp;", "  &nbsp;", "  &nbsp;")

ranef_table %>% 
  knitr::kable(format = "pandoc", align = str_tokenize("llrrrrrr"))
```

Appendix 2: Growth curve model random effects











# Statistical Analysis

```{r, 'write-up-prep', warning=F}
# Prepare table to support easy in-line printing of equations
params <- pretty_fixed_effects %>% 
  rename(B = Estimate, t = `_t_`, p = `_p_`)
params$B %<>% str_replace("&minus;", "-")
params$SE %<>% str_replace("&minus;", "-")
params$t %<>% str_replace("&minus;", "-")
params$p %<>% str_replace("< ", "") %>% as.numeric

params$subscript <- 
  c(paste0(0:3, 0), paste0(0:3, 1), 
    paste0(0:3, 2), paste0(0:3, 3), 
    paste0(0:3, 4), paste0(0:3, 5), 
    paste0(0:3, 6), paste0(0:3, 7), 
    paste0(0:3, 8), paste0(0:3, 9))

params <- tibble::column_to_rownames(params, 'subscript')

params$subscript <- 
  c(paste0(0:3, 0), paste0(0:3, 1), 
    paste0(0:3, 2), paste0(0:3, 3), 
    paste0(0:3, 4), paste0(0:3, 5), 
    paste0(0:3, 6), paste0(0:3, 7), 
    paste0(0:3, 8), paste0(0:3, 9))

# Shortcut for inline reporting from the above table
report_row <- function(row_name) report_fixef_row(params, row_name)

# Pre-calculate intercept as proportion
b0 <- params$B[params$subscript == "00"] %>% as.numeric
b0_prop <- b0 %>% inv_logit %>% round(2) %>% remove_leading_zero

```

Example write up (must be rewritten)  

(Reporting rows from final model)  

Figure 1 plots the model estimates from the GCA, and the full model summary is 
available in Appendices 1 and 2. 
We report the results for the M group and then provide comparisons with and 
between the learner groups. 
The model intercept estimates the log odds of M fixating on the target, 
averaging over the time course, lexical stress, and syllable structure, at the 
mean working memory (XXX). 
The log odds were _&gamma;_~00~&nbsp;=&nbsp;`r fixed_digits(b0, 2)` 
(proportion:&nbsp;`r b0_prop`). 
The linear, quadratic, and cubic polynomial time terms captured the sigmoid 
shape of the time course and were retained in the model 
(`r report_row("10")`; `r report_row("20")`; `r report_row("30")`). 

(Reporting nested model comparisons)  

There was (was not) a main effect of XXX on the quadratic time term 
(`r pretty_chi_result(nested_model_comparisons_wm$ss_wm_anova, 
"gca_mod_ss_wm_1")`). 
